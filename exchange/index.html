<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì½”ì¸ ë ˆí¼ëŸ´ ëª¨ìŒ</title>
  <meta name="description" content="ê±°ë˜ì†Œ ë ˆí¼ëŸ´ ì •ë³´ë¥¼ ê¹”ë”í•˜ê²Œ ëª¨ì•„ë‘” í˜ì´ì§€ì…ë‹ˆë‹¤. ê²€ìƒ‰ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì°¾ê³ , ìƒì„¸ í˜ì´ì§€ì—ì„œ ë§í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”." />

  <!-- ê³µí†µ CSS -->
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <main class="container">
    <div class="topbar">
      <div>
        <h1 class="page-title">í‚´ìŠ¤ í˜ì´ë°±</h1>
        <p class="page-subtitle">í•´ì™¸ ê±°ë˜ì†Œ ìˆ˜ìˆ˜ë£Œ í• ì¸ ì •ë³´</p>
      </div>

      <div class="search" role="search" aria-label="ê²€ìƒ‰">
        <span aria-hidden="true">ğŸ”</span>
        <input id="q" type="search" placeholder="ê±°ë˜ì†Œ ì´ë¦„/í‚¤ì›Œë“œ ê²€ìƒ‰ (ì˜ˆ: ì—…ë¹„íŠ¸, ë¹—ì¸, ë°”ì´ë‚¸ìŠ¤)" />
      </div>
    </div>

    <!-- ì¹´ë“œ ëª©ë¡ì´ ë“¤ì–´ê°ˆ ì˜ì—­: card-grid -->
    <section id="cards" class="card-grid" aria-label="ë ˆí¼ëŸ´ ëª©ë¡"></section>

    <div class="footer">
      Â© <span id="y"></span> Coin Referral. Built with HTML/CSS/JS (no build tools).
    </div>
  </main>

  <script>
    // footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    const $cards = document.getElementById('cards');
    const $q = document.getElementById('q');

    let all = [];

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function makeCard(item) {
      // item í•„ë“œëŠ” referrals.json êµ¬ì¡°ì— ë§ì¶° ì‚¬ìš©:
      // id, title, summary(or description), subline, tags, link
      const id = item.id;
      const title = item.title || item.name || id;

      // ì§€ë‹ˆ JSONì€ summaryë¥¼ ì“°ê³  ìˆìœ¼ë‹ˆ summary ìš°ì„ 
      const desc = item.summary || item.description || item.desc || '';
      const subline = item.subline || item.feeLine || '';

      const detailUrl = `./detail.html?id=${encodeURIComponent(id)}`;
      const externalLink = item.link || item.url || item.referralUrl || '';

      const externalBtn = externalLink
        ? `<a class="btn btn-primary" href="${escapeHtml(externalLink)}" target="_blank" rel="noopener noreferrer">ê°€ì…í•˜ê¸°</a>`
        : `<a class="btn btn-primary" href="${detailUrl}">ìƒì„¸ì—ì„œ í™•ì¸</a>`;

      // íˆì–´ë¡œ ë°°ì§€: tags ì¤‘ '%' ë“¤ì–´ê°„ í•­ëª© (ì˜ˆ: "50% í• ì¸", "20% í• ì¸")
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const hero = tags.find(t => /%/.test(String(t))) || '';

      // â€œì‹œì¥ê°€ ê¸°ì¤€â€ ë¼ë²¨ì€ tagsì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
      const basis = tags.find(t => String(t).includes('ì‹œì¥ê°€')) || 'ì‹œì¥ê°€ ê¸°ì¤€';

      // sublineì—ì„œ "ì‹œì¥ê°€ ìˆ˜ìˆ˜ë£Œ" ê°™ì€ ì•ë¶€ë¶„ì€ ì œê±°í•´ì„œ ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
      const feeNumbers = String(subline || '')
        .replace(/^ì‹œì¥ê°€\s*ìˆ˜ìˆ˜ë£Œ\s*/g, '')
        .replace(/^ì‹œì¥ê°€\s*/g, '')
        .trim();

      // íƒœê·¸ëŠ” ì¹´ë“œ ì•„ë˜ì—ì„œ ì§€ì €ë¶„í•´ì§€ì§€ ì•Šê²Œ: hero(í• ì¸ìœ¨) / ì‹œì¥ê°€ ê¸°ì¤€ì€ ì œì™¸
      const cleanTags = tags.filter(t => t !== hero && !String(t).includes('ì‹œì¥ê°€'));
      const tagsHtml = cleanTags.slice(0, 4).map(t => `<span class="pill">${escapeHtml(t)}</span>`).join('');

      return `
        <article class="card">
          <h2 class="card-title">${escapeHtml(title)}</h2>

          ${hero ? `<div class="hero-badge">ğŸ”¥ ${escapeHtml(hero)}</div>` : ``}

          ${feeNumbers ? `
            <div class="fee-box">
              <div class="fee-row">
                <span class="fee-label">${escapeHtml(basis)}</span>
                <p class="fee-value">${escapeHtml(feeNumbers)}</p>
              </div>
            </div>
          ` : ``}

          ${desc ? `<p class="card-desc">${escapeHtml(desc)}</p>` : ``}

          ${tagsHtml ? `<div class="card-meta">${tagsHtml}</div>` : ``}

          <div class="actions">
            ${externalBtn}
            <a class="btn btn-outline" href="${detailUrl}">ìƒì„¸ ë³´ê¸°</a>
          </div>
        </article>
      `;
    }


    function render(list) {
      if (!list.length) {
        $cards.innerHTML = `
          <div class="detail">
            <h1>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</h1>
            <p>ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
          </div>
        `;
        return;
      }
      $cards.innerHTML = list.map(makeCard).join('');
    }

    function applySearch() {
      const q = ($q.value || '').trim().toLowerCase();
      if (!q) return render(all);

      const filtered = all.filter(it => {
        const blob = [
          it.id,
          it.title, it.name,
          it.description, it.desc,
          Array.isArray(it.tags) ? it.tags.join(' ') : ''
        ].join(' ').toLowerCase();

        return blob.includes(q);
      });

      render(filtered);
    }

    async function load() {
      try {
        const res = await fetch('../data/referrals.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('referrals.json ë¡œë“œ ì‹¤íŒ¨: ' + res.status);

        const data = await res.json();

        // dataê°€ ë°°ì—´ì´ê±°ë‚˜ {items:[...]} í˜•íƒœì¼ ìˆ˜ ìˆì–´ì„œ ë‘˜ ë‹¤ ì§€ì›
        all = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);

        // id ì—†ëŠ” ë°ì´í„°ëŠ” ì œì™¸
        all = all.filter(x => x && x.id);

        render(all);
      } catch (err) {
        console.error(err);
        $cards.innerHTML = `
          <div class="detail">
            <h1>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”</h1>
            <p>../data/referrals.json íŒŒì¼ ê²½ë¡œ ë˜ëŠ” JSON ë¬¸ë²•(ì‰¼í‘œ/ë”°ì˜´í‘œ)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
      }
    }

    $q.addEventListener('input', applySearch);

    load();
  </script>
</body>
</html>
