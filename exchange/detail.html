<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>레퍼럴 상세</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <div class="container">
    <a class="smallLink" href="/exchange/">← 목록으로</a>

    <div id="box" class="detail" style="margin-top:12px;"></div>

    <div class="footer">
      <span class="smallLink">※ 혜택/조건은 변동될 수 있어요.</span>
    </div>
  </div>

<script>
async function loadData(){
  const res = await fetch('/data/referrals.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('데이터를 불러오지 못했어요');
  return res.json();
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, (m)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function getId(){
  const u = new URL(location.href);
  return u.searchParams.get('id');
}

(async ()=>{
  const box = document.getElementById('box');
  const id = getId();
  if(!id){
    box.innerHTML = `
      <h1>잘못된 접근</h1>
      <p>id가 없어요. 목록에서 다시 선택해줘.</p>
      <div class="btnRow"><a class="btn btnPrimary" href="/exchange/">목록으로</a></div>
    `;
    return;
  }

  try{
    const all = await loadData();
    const item = all.find(x => String(x.id) === String(id));
    if(!item){
      box.innerHTML = `
        <h1>찾을 수 없음</h1>
        <p>해당 id의 항목이 없어요: <b>${escapeHtml(id)}</b></p>
        <div class="btnRow"><a class="btn btnPrimary" href="/exchange/">목록으로</a></div>
      `;
      return;
    }

    document.title = item.title ? `${item.title} - 레퍼럴` : '레퍼럴 상세';

    const notes = Array.isArray(item.notes) ? item.notes : [];
    const badges = [
      item.category ? `카테고리: ${item.category}` : null,
      item.updatedAt ? `업데이트: ${item.updatedAt}` : null
    ].filter(Boolean);

    box.innerHTML = `
      <h1>${escapeHtml(item.title)}</h1>
      <p>${escapeHtml(item.summary)}</p>

      <div class="badgeRow">
        ${badges.map(b=>`<span class="badge">${escapeHtml(b)}</span>`).join('')}
      </div>

      ${notes.length ? `
        <ul class="list">
          ${notes.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}
        </ul>
      ` : ''}

      <div class="btnRow">
        <a class="btn btnPrimary" href="${escapeHtml(item.link)}" target="_blank" rel="noopener">
          레퍼럴 링크로 이동
        </a>
      </div>
    `;
  }catch(e){
    box.innerHTML = `
      <h1>오류</h1>
      <p>${escapeHtml(e.message)}</p>
      <div class="btnRow"><a class="btn btnPrimary" href="/exchange/">목록으로</a></div>
    `;
  }
})();
</script>
</body>
</html>